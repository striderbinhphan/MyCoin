<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>BinhCoin</title>
		<!-- Description, Keywords and Author -->
		<meta name="description" content="Your description">
		<meta name="keywords" content="Your,Keywords">
		<meta name="author" content="HimanshuGupta">
		
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<!-- Styles -->
		<!-- Bootstrap CSS -->
		<link href="css/bootstrap.min.css" rel="stylesheet">	
		<!-- Animate CSS -->
		<link href="css/animate.min.css" rel="stylesheet">
		<!-- Basic stylesheet -->
		<link rel="stylesheet" href="css/owl.carousel.css">
		<!-- Font awesome CSS -->
		<link href="css/font-awesome.min.css" rel="stylesheet">		
		<!-- Custom CSS -->
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-color.css" rel="stylesheet">
		<link href="css/hover.css" rel="stylesheet">
		<!-- Favicon -->
		<link rel="shortcut icon" href="img/logo/favicon.ico">
		<link rel="stylesheet" href="css/jquery.mCustomScrollbar.min.css" />
		<link rel="stylesheet" href="css/datatables.min.css">
		<script src="js/FileSaver.js"></script>
	</head>
	
	<body>
		
		<!-- Mining Block Modal -->
		<div class="modal fade" id="miningBlock" tabindex="-1" role="dialog" aria-labelledby="miningBlock" aria-hidden="true">
			<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
				<h5 class="modal-title" id="miningBlockLabel">Mine this block</h5>
				<h6>Please retype your reward Address to get reward when mining new Block</h6>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				</div>
				<div class="modal-body">
					<form>
						<div class="form-group">
						  <label for="rewardAddress" class="col-form-label">Reward Address:</label>
						  <input type="text" class="form-control" id="rewardAddress" required>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button onclick="miningBlock()" type="button" data-dismiss="modal" class="btn btn-success">Mine Block</button>
				</div>
			</div>
			</div>
		</div>


		<!-- modal for booking ticket form -->
		<div class="modal fade" id="notify" tabindex="-1" role="dialog" aria-labelledby="notify">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="">Unconfirm Transactions</h5>
					</div>
					<div class="modal-body">
						<form>
							<div class="form-group">
								<ul id="transactions" class="list-unstyled">
												
								</ul>
							</div>
						</form>
					</div>
					<!-- form for events ticket booking -->
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary" data-dismiss="modal" data-toggle="modal" data-target="#miningBlock">
							Mining
						</button>		
					</div>
				</div>
			</div>
		</div>
		
			
		<!-- wrapper -->
		<div class="wrapper" id="home">
		
			<!-- header area -->
			<header>
				<!-- secondary menu -->
				<nav class="secondary-menu">
					<div class="container">
						<!-- secondary menu left link area -->
						<div class="sm-left">
							<strong>Phone</strong>:&nbsp; <a href="#">+8432864xxxx</a>&nbsp;&nbsp;&nbsp;&nbsp;
							<strong>E-mail</strong>:&nbsp; <a href="#">pipporkk@gmail.com</a>
						</div>
						<!-- secondary menu right link area -->
						<div class="sm-right">
							<!-- social link -->
							<div class="sm-social-link">
								<a class="h-facebook" href="#"><i class="fa fa-facebook"></i></a>
								<a class="h-twitter" href="#"><i class="fa fa-twitter"></i></a>
								<a class="h-google" href="#"><i class="fa fa-google-plus"></i></a>
								<a class="h-linkedin" href="#"><i class="fa fa-linkedin"></i></a>
							</div>
						</div>
						<div class="clearfix"></div>
					</div>
				</nav>
				<!-- primary menu -->
				<nav class="navbar navbar-fixed-top navbar-default">
					<div class="container">
						<!-- Brand and toggle get grouped for better mobile display -->
						<div class="navbar-header">
							<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
								<span class="sr-only">Toggle navigation</span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
							</button>
							<!-- logo area -->
							<a class="navbar-brand" href="index.html">
								<h4>Binh Coin</h4>
								<!-- logo image -->
								<img class="img-responsive"  alt="" />
							</a>
						</div>

						<!-- Collect the nav links, forms, and other content for toggling -->
						<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
							<ul class="nav navbar-nav navbar-right mr-auto">
								<li id="unconfirmNavItem"><a data-toggle="modal" data-target="#notify"><span id="pendingTxsTotal">0</span><i class="fa fa-bell">Unconfirm Transactions</i></a></li>
								<li><a href="#blockchainexplorer">Wallet info</a></li>
								<li class="nav-item dropdown">
									<a  class="nav-link dropdown-toggle value-address-text" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										<span>Hi,</span><span id="userAddress1"></span>									
									</a>
									<div class="dropdown-menu" aria-labelledby="navbarDropdown">
										<i class="fa fa-logout"></i><a class="dropdown-item" href="/index.html">Logout</a>
									</div>
								</li>
							</ul>
						</div><!-- /.navbar-collapse -->
					</div><!-- /.container-fluid -->
				</nav>
			</header>
			<!--/ header end -->
			
			<!-- banner area -->
			<div class="banner">
				<div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
					<!-- Wrapper for slides -->
					<div class="carousel-inner" role="listbox">
						<div class="item active">
							<img src="img/banner/blockchain3.jpg" alt="...">
							<div class="container">
								<!-- banner caption -->
								<div class="carousel-caption slide-one">
									<h2 class="value-address-text">Hi,<span  id="userAddress2"></span></h2>
									<!-- heading -->
									<h2 class="animated fadeInLeftBig"><i class="fa fa-hand-o-right "></i> Cryptocurrency For You!</h2>
									<!-- paragraph -->
									<h3 class="animated fadeInRightBig">Sending &amp; Mining reward</h3>
									<!-- button -->
						
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--/ banner end -->
			
			<!-- block for animate navigation menu -->
			<div class="nav-animate"></div>
			
			<!-- Hero block area -->
			<div id="blockchainexplorer" class="hero pad">
				<div class="container">
					<!-- hero content -->
					<div class="hero-content ">
						<div class="container d-flex justify-content-space-between">
							<div class="row">
								<div class="col-md-6 col-sm-6">
									<div >
										<div class="card p-3">
											<p class="text-dark">Your Wallet</p>
											<div class="card-bottom pt-3 px-3 mb-2">
												<div class="d-flex flex-row justify-content-between text-align-center">
													<div class="d-flex flex-column"><span>Balance amount:</span>
														<p>&dollar; <span id="walletBalance" class="text-white">0</span></p>
													</div> 
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="col-md-6 col-sm-6">
									<p class="text-dark">Send coin</p>

									<form>
										<div class="form-group">
										  <label for="toReceiverAddress">To:</label>
										  <input type="text" class="form-control" id="toReceiverAddress" aria-describedby="receiver" placeholder="Enter Address" required>
										  <small id="receiver" class="form-text text-muted">type your receiver Address</small>
										</div>
										<div class="form-group">
										  <label for="amount">Amount:</label>
										  <input type="number" class="form-control" id="amount" placeholder="amount" min="0" required>
										</div>
										<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sendTransaction">
											Send
										</button>										  
									</form>

									<!-- Modal -->
									<div class="modal fade" id="sendTransaction" tabindex="-1" role="dialog" aria-labelledby="sendTransaction" aria-hidden="true">
										<div class="modal-dialog" role="document">
										<div class="modal-content">
											<div class="modal-header">
											<h5 class="modal-title" id="sendTransactionLabel">Send transaction</h5>
											<h6>Please retype your Private Key to access your Wallet</h6>
											<button type="button" class="close" data-dismiss="modal" aria-label="Close">
												<span aria-hidden="true">&times;</span>
											</button>
											</div>
											<div class="modal-body">
												<form>
													<div class="form-group">
													  <label for="private-key" class="col-form-label">Private Key:</label>
													  <input type="password" class="form-control" id="private-key" required>
													</div>
												</form>
											</div>
											<div class="modal-footer">
												<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
												<button onclick="sendTransaction()" type="button" class="btn btn-primary">Send</button>
											</div>
										</div>
										</div>
									</div>

								</div>
							</div>
						</div>
						<hr>
						<!-- heading -->
						<h2>Your Transaction</h2>
					</div>
					<!-- hero play list -->
					<div class="hero-block">
						<div class="row">
							<div class="col-md-6 col-sm-6">
								<div class="card card-wrapper">
									<div class="card-header">
										<h4>Sending transaction</h4>
										<hr>
									</div>
									<div class="card-body">
										<!-- play list -->
										<div class="block-content force-overflow scroll-custom block-scroll-action">
											<table id="sendingTxs_table" class="table table-striped table-bordered" style="width:100%">
												<thead>
													<tr>
														<th>#</th>
														<th>To</th>
														<th>Amount</th>
													</tr>
												</thead>
												<tbody id="sendingTxs_body_container">
													
												</tbody>
												
											</table>	
											<div id="sendingTxs_responseTotalTxs">

											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-6 col-sm-6">
								<div class="card card-wrapper">
									<div class="card-header">
										<h4>Receiving transaction</h4>
										<hr>
									</div>
									<div class="card-body">
										<!-- play list -->
										<div class="block-content force-overflow scroll-custom block-scroll-action">
											<table id="receivingTxs_table" class="table table-striped table-bordered" style="width:100%">
												<thead>
													<tr>
														<th>#</th>
														<th>From</th>
														<th>Amount</th>
													</tr>
												</thead>
												<tbody id="receivingTxs_body_container">
													
												</tbody>
												
											</table>	
											<div id="receivingTxs_responseTotalTxs">

											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--/ hero end -->
		
			
			<!-- meet -->
			<div class="meet parallax-four pad" id="meet">
				<div class="container">
					<!-- default heading -->
					<div class="default-heading-shadow">
						<h2>Upcoming Meets</h2>
					</div>
					<!-- meet location image -->
					<div class="meet-map">
						<img class="img-responsive img-map" src="img/flat/map.png" alt="" />
						<!-- map marker for India  -->
						<a href="#" class="map-marker india " data-toggle="tooltip" data-placement="top" title="India"><img class="img-responsive" src="img/flat/map-marker.png" alt="" /></a>
						<!-- map marker for United States  -->
						<a href="#" class="map-marker usa " data-toggle="tooltip" data-placement="top" title="United States"><img class="img-responsive" src="img/flat/map-marker.png" alt="" /></a>
						<!-- map marker for South Africa  -->
						<a href="#" class="map-marker sa " data-toggle="tooltip" data-placement="top" title="South Africa"><img class="img-responsive" src="img/flat/map-marker.png" alt="" /></a>
						<!-- map marker for Russia  -->
						<a href="#" class="map-marker russia " data-toggle="tooltip" data-placement="top" title="Russia"><img class="img-responsive" src="img/flat/map-marker.png" alt="" /></a>
						<!-- map marker for Brazil  -->
						<a href="#" class="map-marker brazil " data-toggle="tooltip" data-placement="top" title="Brazil"><img class="img-responsive" src="img/flat/map-marker.png" alt="" /></a>
					</div>
				</div>
			</div>
			<!-- meet end -->
			

			<!-- footer -->
			<footer>
				<div class="container">
					<!-- social media links -->
					<div class="social">
						<a class="h-facebook" href="#"><i class="fa fa-facebook"></i></a>
						<a class="h-google" href="#"><i class="fa fa-google-plus"></i></a>
						<a class="h-linkedin" href="#"><i class="fa fa-linkedin"></i></a>
						<a class="h-twitter" href="#"><i class="fa fa-twitter"></i></a>
					</div>
					<!-- copy right -->
					<p class="copy-right">&copy; copyright 2018, All rights are reserved.</p>
				</div>
			</footer>
			<!-- footer end -->
			
			<!-- Scroll to top -->
			<span class="totop"><a href="#"><i class="fa fa-chevron-up"></i></a></span> 
		</div>
		
		<!-- Javascript files -->
		
		<!-- jQuery -->
		<script src="js/jquery.js"></script>
		<script src="js/jquery.mCustomScrollbar.js"></script>	
		<!-- Bootstrap JS -->
		<script src="js/bootstrap.min.js"></script>
		<!-- WayPoints JS -->
		<script src="js/waypoints.min.js"></script>
		<!-- Include js plugin -->
		<script src="js/owl.carousel.min.js"></script>
		<!-- One Page Nav -->
		<script src="js/jquery.nav.js"></script>
		<!-- Respond JS for IE8 -->
		<script src="js/respond.min.js"></script>
		<!-- HTML5 Support for IE -->
		<script src="js/html5shiv.js"></script>
		<!-- Custom JS -->
		<script src="js/custom.js"></script>
		<!--Datatable-->
		<script src="js/datatables.min.js"></script>
		<script src="js/custom.js"></script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>
		<script id="transaction-template" type="text/x-handlebars-template">
			{{#each this}}
				<li class="block-item">
					<!-- song information -->
					<div class="block-info" >
						<!-- song title -->
						<h4>Transaction</h4>
						<div class="group-item-block">
							<div class="item-text-block">
								<span class="name-block-text">From Address :</span>
								<a href="wallet.html?address={{fromAddress}}" class="value-block-text">{{fromAddress}}</a>
							</div>
							<div class="item-text-block">
								<span class="name-block-text">To Address :</span>
								<a href="wallet.html?address={{toAddress}}" class="value-block-text">{{toAddress}}</a>
							</div>
							<div class="item-text-block">
								<span class="name-block-text">Amount :</span>
								<span class="value-block-text">{{amount}}</span>
							</div>
						</div>
					</div>
					<!-- music icon -->
					<!-- <div class="music-icon">
						<a href="#"><i class="fa fa-play"></i></a>
						<a href="#"><i class="fa fa-pause"></i></a>
					</div> -->
					<div class="clearfix"></div>
				</li>
			{{/each}}
		</script>
		<script>
			let ts = 0;
			window.onload = initWalletAccessing();
			function initWalletAccessing(){
				loadWalletInfo();
				setInterval(() => {
					loadWalletBalance();
					loadPendingTransactions();
				}, 5000);
			}
			function loadWalletBalance() { 
				let currentUrlString = window.location.href;
				let currentUrl = new URL(currentUrlString);
				let address = currentUrl.searchParams.get("address");
				const url = 'http://localhost:3001/balance'+"/"+address.toString();
				axios.get(url).then(function (res) {
					console.log(res.data);
					document.getElementById("walletBalance").innerHTML = '';
					document.getElementById("walletBalance").innerHTML = res.data.balance;
				}).catch(function (err) {  
					console.log(err);
				});
			};
			function loadWalletInfo() {
				let currentUrlString = window.location.href;
				let currentUrl = new URL(currentUrlString);
				let address = currentUrl.searchParams.get("address");
				console.log(currentUrl.searchParams.get("address"));
				document.getElementById("userAddress1").innerHTML = address;
				document.getElementById("userAddress2").innerHTML = address;
				
				const urlWalletTransactions = 'http://localhost:3001/transactions' + '/' + address.toString();
				axios.get(urlWalletTransactions).then(function(res){
					
					if(res.data.sendingTxs.length!=0){
						let i=0;
						for (f of res.data.sendingTxs) {
							const tr = `<tr >
										<th scope="row">${i}</th>
										<td class="value-toAddress-text"><a href="walletdetail.html?address=${f.toAddress}" class="value-block-text">${f.toAddress}</a></td>
										<td>${f.amount}</td>
									</tr>`;
								$('#sendingTxs_body_container').append(tr);
							i+=1;
						}

						$('#sendingTxs_table').DataTable();
					}
					else{
						document.getElementById("sendingTxs_responseTotalTxs").innerHTML = "This wallet doesnot create any transactions";
					}
					if(res.data.receivingTxs.length!=0){
						let i=0;
						for (f of res.data.receivingTxs) {
							let fromAddress =  f.fromAddress?f.fromAddress:"system";
							const tr = `<tr >
										<th scope="row">${i}</th>
										<td class="value-toAddress-text"><a href="walletdetail.html?address=${fromAddress}" class="value-block-text">${fromAddress}</a></td>
										<td>${f.amount}</td>
									</tr>`;
								$('#receivingTxs_body_container').append(tr);
							i+=1;
						}

						$('#receivingTxs_table').DataTable();
					}
					else{
						document.getElementById("receivingTxs_responseTotalTxs").innerHTML = "This wallet doesnot create any transactions";
					}
				});
			}
			function loadPendingTransactions() {
				let pendingUrl = `http://localhost:3001/pendingTransactions?ts=${ts}`;
				axios.get(pendingUrl).then(function (res) {
					const transactionSource = document.getElementById("transaction-template").innerHTML;
					const transactionTemplate = Handlebars.compile(transactionSource);
					const transactionHtml = transactionTemplate(res.data.pendingTransactions);
					document.getElementById('transactions').innerHTML += transactionHtml;
					ts = res.data.returnTimestamp;
					console.log(ts);
					if(res.data.totalPendingTransactions ==0){
						var elem = document.getElementById("transactions");
  						elem.innerHTML = '';
						document.getElementById('unconfirmNavItem').style.visibility = "hidden";
					}else{
						document.getElementById('unconfirmNavItem').style.visibility = "visible";
						document.getElementById("pendingTxsTotal").innerHTML = res.data.totalPendingTransactions;
					}
					
				}).catch(function(err){
					console.log(err);
				});
			}
		</script>
		<script>
			function sendTransaction() {
				let currentUrlString = window.location.href;
				let currentUrl = new URL(currentUrlString);
				let fromAddress = currentUrl.searchParams.get("address");
				let toAddress = document.getElementById('toReceiverAddress').value;
				let amount = document.getElementById('amount').value;
				let privateKey  = document.getElementById('private-key').value;
				let addNewTxsURL = "http://localhost:3001/transactions";
				axios.post(addNewTxsURL,{
					publicKey: fromAddress,
					privateKey: privateKey,
					toAddress: toAddress,
					amount: amount
				}).then(function (res) { 
					console.log(res.data);
					$('#sendTransaction').modal('hide');
				}).catch(function (err) { console.log(err)  });

			}
			function miningBlock(){
				let mineNewBlockUrl = 'http://localhost:3001/blocks';
				let rewardAddress  = document.getElementById('rewardAddress').value;
				console.log(rewardAddress);
				axios.post(mineNewBlockUrl,{
					rewardAddress: rewardAddress
				}).then(function(res){
					console.log(res.data);
					alert(res.data);
				});
			}
		</script>
	</body>	
</html>